env:
   global:
     # TRAVIS_BRANCH is tag name if tag provided else branch name
     - XMSCORE_VERSION: $TRAVIS_BRANCH
     - CONAN_REFERENCE: "xmscore/${XMSCORE_VERSION}"
     - CONAN_USERNAME: "aquaveo"
     - CONAN_CHANNEL: "stable"
     - CONAN_LOGIN_USERNAME: $CONAN_USER_SECRET
     - CONAN_PASSWORD: $CONAN_PASSWORD_SECRET
     
linux: &linux
   os: linux
   sudo: required
   language: python
   python: "3.6"
   services:
     - docker
osx: &osx
   os: osx
   language: generic

stages:
    - name: test
      if: NOT tag IS present
    - name: deploy
      if: tag =~ ^\d+\.\d+\.\d+$

# Global Lifecycle Steps
# See: https://docs.travis-ci.com/user/customizing-the-build/#The-Build-Lifecycle

# Install Step
install:
  - chmod +x .travis/install.sh
  - ./.travis/install.sh

# Build Step
script:
  - chmod +x .travis/run.sh
  - ./.travis/run.sh

# After Success
after_success:
  - python test.py

# Jobs/Build Matrix
# Note: Lifecycle Steps specified in stages will override Global Lifecycle Steps
jobs:
   include:
      # --- TEST STAGE ------------------------------------------------------------------------------------------------
      - stage: test
        <<: *linux
        env: CONAN_GCC_VERSIONS=4.9 CONAN_DOCKER_IMAGE=lasote/conangcc49

      - stage: test
        <<: *linux
        env: CONAN_GCC_VERSIONS=5 CONAN_DOCKER_IMAGE=lasote/conangcc5

      - stage: test
        <<: *linux
        env: CONAN_GCC_VERSIONS=6 CONAN_DOCKER_IMAGE=lasote/conangcc6

      - stage: test
        <<: *linux
        env: CONAN_GCC_VERSIONS=7 CONAN_DOCKER_IMAGE=lasote/conangcc7

      - stage: test
        <<: *osx
        osx_image: xcode9.2
        env: CONAN_APPLE_CLANG_VERSIONS=9.0

      # --- DEPLOY STAGE ----------------------------------------------------------------------------------------------
      - stage: deploy
        <<: *linux
        env: CONAN_GCC_VERSIONS=4.9 CONAN_DOCKER_IMAGE=lasote/conangcc49 CONAN_UPLOAD=$AQUAVEO_CONAN
        after_success: true

      - stage: deploy
        <<: *linux
        env: CONAN_GCC_VERSIONS=5 CONAN_DOCKER_IMAGE=lasote/conangcc5 CONAN_UPLOAD=$AQUAVEO_CONAN
        after_success: true

      - stage: deploy
        <<: *linux
        env: CONAN_GCC_VERSIONS=6 CONAN_DOCKER_IMAGE=lasote/conangcc6 CONAN_UPLOAD=$AQUAVEO_CONAN
        after_success: true

      - stage: deploy
        <<: *linux
        env: CONAN_GCC_VERSIONS=7 CONAN_DOCKER_IMAGE=lasote/conangcc7 CONAN_UPLOAD=$AQUAVEO_CONAN
        after_success: true

      - stage: deploy
        <<: *osx
        osx_image: xcode9.2
        env: CONAN_APPLE_CLANG_VERSIONS=9.0 CONAN_UPLOAD=$AQUAVEO_CONAN
        after_success: true
